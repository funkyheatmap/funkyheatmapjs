<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FunkyHeatmap.js Reproducing scIB figure</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="styles/tomorrow-night.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="static/main.css">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
    <script src='static/main.js'></script>
  
</head>


<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
             
                <a class="image" href="index.html">
                    <img src="https://raw.githubusercontent.com/funkyheatmap/logo/refs/heads/main/src/funkyheatmap_edited.svg" alt="logo">
                </a>
            
             
                <a href="index.html">
                    <h1 class="navbar-item">FunkyHeatmap.js</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                <div class="dropdown is-hoverable is-right">
                    <a class="dropdown-trigger link">
                        Tutorials
                        <i class="fas fa-chevron-down fa-xs"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-content">
                        
                            <a class="dropdown-item" href="tutorial-simple.html">
                                Basic usage
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-full.html">
                                Customizing the heatmap
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-scIB.html">
                                Reproducing scIB figure
                            </a>
                        
                        </div>
                    </div>
                </div>
                
                 
                    
                        <a
                            class="link user-link "
                            href="https://github.com/funkyheatmap/funkyheatmapjs"
                        >
                            Github
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://github.com/funkyheatmap/funkyheatmapjs/blob/main/CHANGELOG.md"
                        >
                            Changelog
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://www.npmjs.com/package/funkyheatmapjs"
                        >
                            NPM package
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://funkyheatmap.github.io/funkyheatmap"
                        >
                            R version
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://funkyheatmap.github.io/funkyheatmappy"
                        >
                            Python version
                        </a>
                    
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar tutorials"
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <div class="category"><h3>Tutorials</h3><ul><li><a href="tutorial-simple.html">Basic usage</a></li><li><a href="tutorial-full.html">Customizing the heatmap</a></li><li><a href="tutorial-scIB.html">Reproducing scIB figure</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                
                    <header class="page-title">
                        <p>Tutorial</p>
                        <h1>Reproducing scIB figure</h1>
                    </header>
                
                <section>

<article>
    <!DOCTYPE html><html lang="en"><head><script type="module" src="scIB.0e084f7f.js"></script><title>A JavaScript project</title><meta name="viewport" content="width=device-width, initial-scale=1"><style>.tutorial-body{-webkit-text-size-adjust:100%;margin:0;padding:10px 50px 50px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,Helvetica Neue,Helvetica,sans-serif;line-height:1.2}.hidden{display:none}</style></head><body class="tutorial-body"> <div class="hidden tutorial-content"> <h3>Introduction</h3> <p>As in the <a href="https://funkyheatmap.github.io/funkyheatmap/articles/scIB.html">R version</a>, we will try to reproduce the results figure from <a href="https://theislab.github.io/scib-reproducibility/">single-cell integration benchmark (scIB)</a> paper (Luecken et al., <em>Nat Met</em>, 2022). The purpose of the paper was to systematically evaluate and compare the performance of methods for integrating single-cell RNA and ATAC sequencing datasets.</p> <p>This is the original figure:</p> <img src="https://github.com/theislab/scib-reproducibility/blob/main/data/img/best-RNA.png?raw=true" alt="scIB figure" style="width:100%;max-width:800px"> <h3>Data</h3> <p>We have included <a href="scib_summary.csv">scib_summary.csv</a> from <a href="https://github.com/funkyheatmap/funkyheatmap">funkyheatmap</a> <code>data</code>. Additionally, this data needs some preprocessing to be used in <em class="pname">funkyheatmapjs</em>.</p> <pre class="lang-javascript prettyprint source"><code>function prepareData(data) {
    const SCALING_LABELS = {
        'Unscaled': '–',
        'Scaled': '+'
    };
    const FEATURES_LABELS = {
        'Full': 'FULL',
        'HVG': 'HVG'
    };
    const OUTPUT_IMG = {
        'Features': 'matrix.png',
        'Embedding': 'embedding.png',
        'Graph': 'graph.png'
    };

    data.forEach((item, idx) => {
        item.id = (idx + 1).toString();
        item.scaling = SCALING_LABELS[item.scaling];
        item.features = FEATURES_LABELS[item.features];
        item.output_img = OUTPUT_IMG[item.output];
    });

    data = rowToColData(data);

    const RANKS = {
        'rank_pancreas': 'label_pancreas',
        'rank_lung_atlas': 'label_lung_atlas',
        'rank_immune_cell_hum': 'label_immune_cell_hum',
        'rank_immune_cell_hum_mou': 'label_immune_cell_hum_mou',
        'rank_mouse_brain': 'label_mouse_brain',
        'rank_simulations_1_1': 'label_simulations_1_1',
        'rank_simulations_2': 'label_simulations_2',
        'package_rank': 'package_label',
        'paper_rank': 'paper_label',
        'time_rank': 'time_label',
        'memory_rank': 'memory_label'
    };

    function labelTop3(vector) {
        // d3.rank behaves like R `rank` with `ties.method = "min"`
        let ranks = d3.rank(vector.map(i => +i));
        return ranks.map(rank => {
            if (rank < 3) {
                return (rank + 1).toString();
            }
            return '';
        })
    }

    for (let [rank, label] of Object.entries(RANKS)) {
        data[label] = labelTop3(data[rank]);
        const [min, max] = d3.extent(data[rank].map(i => +i));
        data[rank] = data[rank].map(x => 1 - (x - min) / (max - min));
    }

    return data;
}</code></pre> <p>Here we created an <code>id</code> column with the row numbers, along with replacing some text values and adding image paths for indication of method output. Additionally, we created text label columns for each of the ranking scores, which only have top 3 performers as strings, and empty otherwise.</p> <h3>Column information</h3> <p>Now we need to manually define how each column should be plotted, using <a href="module-columns.html#~ColumnInfo">ColumnInfo</a> options.</p> <pre class="lang-javascript prettyprint source"><code>const column_info = [
    {id: "id", name: "Rank", geom: "text", group: "Method", options: {align: "right"}},
    {id: "method", name: "Method", geom: "text", group: "Method"},
    {id: "output_img", name: "Output", geom: "image", group: "Method", options: {width: 20}},
    {id: "features", id_color: "features", name: "Features", geom: "text", group: "Method", options: {palette: "features"}},
    {id: "scaling", name: "Scaling", geom: "text", group: "Method", options: {fontSize: 18, align: "center"}},
    {id: "overall_pancreas", id_color: "rank_pancreas", name: "Pancreas", geom: "bar", group: "RNA", id_label: "label_pancreas", options: {palette: "blues", width: 1.5, draw_outline: false}},
    {id: "overall_lung_atlas", id_color: "rank_lung_atlas", name: "Lung", geom: "bar", group: "RNA", id_label: "label_lung_atlas", options: {palette: "blues", width: 1.5, draw_outline: false}},
    {id: "overall_immune_cell_hum", id_color: "rank_immune_cell_hum", name: "Immune (human)", geom: "bar", group: "RNA", id_label: "label_immune_cell_hum", options: {palette: "blues", width: 1.5, draw_outline: false}},
    {id: "overall_immune_cell_hum_mou", id_color: "rank_immune_cell_hum_mou", name: "Immune (human/mouse)", geom: "bar", group: "RNA", id_label: "label_immune_cell_hum_mou", options: {palette: "blues", width: 1.5, draw_outline: false}},
    {id: "overall_mouse_brain", id_color: "rank_mouse_brain", name: "Mouse brain", geom: "bar", group: "RNA", id_label: "label_mouse_brain", options: {palette: "blues", width: 1.5, draw_outline: false}},
    {id: "overall_simulations_1_1", id_color: "rank_simulations_1_1", name: "Sim 1", geom: "bar", group: "Simulations", id_label: "label_simulations_1_1", options: {palette: "greens", width: 1.5, draw_outline: false}},
    {id: "overall_simulations_2", id_color: "rank_simulations_2", name: "Sim 2", geom: "bar", group: "Simulations", id_label: "label_simulations_2", options: {palette: "greens", width: 1.5, draw_outline: false}},
    {id: "package_score", id_color: "package_rank", name: "Package", geom: "bar", group: "Usability", id_label: "package_label", options: {palette: "oranges", width: 1.5, draw_outline: false}},
    {id: "paper_score", id_color: "paper_rank", name: "Paper", geom: "bar", group: "Usability", id_label: "paper_label", options: {palette: "oranges", width: 1.5, draw_outline: false}},
    {id: "time_score", id_color: "time_rank", name: "Time", geom: "bar", group: "Scalability", id_label: "time_label", options: {palette: "greys", width: 1.5, draw_outline: false}},
    {id: "memory_score", id_color: "memory_rank", name: "Memory", geom: "bar", group: "Scalability", id_label: "memory_label", options: {palette: "greys", width: 1.5, draw_outline: false}}
];</code></pre> <p>As in the <a href="tutorial-full.html">previous tutorial</a>, here we define how each column should be visualized, with which color scheme, their names and groupings, and some additional options. For the ranking columns, we use <code><a href="module-geoms.html#.bar">bar</a></code> geom with <code>width: 1.5, draw_outline: false</code> options. Importantly, for these columns we use <code>id_color</code> option to indicate a different data column to get the color mapping from (coloring by ranking), and <code>id_label</code> to indicate a separate data column to get the overlaying text from. This uses our prepared column with only top 3 methods labeled.</p> <p></p> <pre class="lang-javascript prettyprint source"><code>const column_groups = [
    {level1: "Method", group: "Method", palette: "black"},
    {level1: "RNA", group: "RNA", palette: "blues"},
    {level1: "Simulations", group: "Simulations", palette: "greens"},
    {level1: "Usability", group: "Usability", palette: "oranges"},
    {level1: "Scalability", group: "Scalability", palette: "greys"}
];</code></pre> <p>For column groups we only define their titles and palettes to use.</p> <h3>Palettes and legends</h3> <pre class="lang-javascript prettyprint source"><code>const palettes = {
    features: {colors: ["#4c4c4c", "#006300"], names: ['FULL', 'HVG']},
    blues: "Blues",
    greens: "Greens",
    oranges: ["#7F2704", "#A63603", "#D94801", "#F16913", "#FD8D3C", "#FDAE6B", "#FDD0A2", "#FEE6CE", "#FFF5EB"],
    greys: "Greys",
    black: ["black", "black"]
};</code></pre> <p>Here we define the color palettes, with the <code>features</code> palette being a <a href="module-palettes.html#~CustomPalette">CustomPalette</a> with colors and names which would provide mapping for the corresponding strings. The rest of the palettes either map to a predefined panel (see <a href="module-palettes.html#~defaultPalettes">defaultPalettes</a>), or simply list colors.</p> <pre class="lang-javascript prettyprint source"><code>const legends = [
    {
        title: "Output",
        geom: "image",
        size: 20,
        values: ["matrix.png", "embedding.png", "graph.png"],
        labels: ["Genes", "Embedding", "Graph"],
    },
    {
        title: "Scaling",
        geom: "text",
        values: ["Scaled", "Unscaled"],
        labels: ["+", "–"],
    },
    {
        title: "RNA rank",
        palette: "blues",
        geom: "rect",
        labels: ["20", "", "10", "", "1"],
        size: [1, 1, 1, 1, 1]
    },
    {
        title: "Simulations rank",
        palette: "greens",
        geom: "rect",
        labels: ["20", "", "10", "", "1"],
        size: [1, 1, 1, 1, 1]
    },
    {
        title: "Usability rank",
        palette: "oranges",
        geom: "rect",
        labels: ["20", "", "10", "", "1"],
        size: [1, 1, 1, 1, 1]
    },
    {
        title: "Scalability rank",
        palette: "greys",
        geom: "rect",
        labels: ["20", "", "10", "", "1"],
        size: [1, 1, 1, 1, 1]
    }
];</code></pre> <p>For each palette used in the <code>column_info</code>, we provide configuration for how to display the legend, with additional legends for Output column (geom <code><a href="module-geoms.html#.image">image</a></code>) and Scaling column (geom <code><a href="module-geoms.html#.text">text</a></code>). Ranking legends use simple rectangles to display progression of colors, with predefined labels.</p> <h3>Rendering</h3> <pre class="lang-javascript prettyprint source"><code>d3.csv('scib_summary.csv').then((data) => {
    data = prepareData(data);

    d3.select("#app").node().appendChild(funkyheatmap(
        data,
        column_info,
        undefined, // row info
        column_groups,
        undefined, // row groups
        palettes,
        legends, // legends
        {rowHeight: 28}, // position options
        { // heatmap options
            labelGroupsAbc: false,
            colorByRank: false
        },
        false // scaleColumn
    ));
});</code></pre> <p>We disable <code>scaleColumn</code> option, because we have preprocessed the data to the <code>[0, 1]</code> range manually, and disable <code>colorByRank</code> while providing ranks as separate columns for colors. No need to specify <code>row_info</code> or <code>row_groups</code>. Full details are in the documentation: <a href="global.html#funkyheatmap">funkyheatmap</a>. For loading the scripts and the surrounding HTML, please see the <a href="tutorial-simple.html">basic tutorial</a>.</p> <h3>Result</h3> </div> <div id="app"></div> <script src="https://unpkg.com/d3@7.8.2/dist/d3.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script> <script type="module" src="scIB.79f7d164.js"></script> </body></html>
</article>

</section>

            </div>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>


</body>
</html>